---
title: "Elasticsarchについて"
date: 2019-09-17T09:00:00+09:00
draft: false
---

## 概要

最近、業務で使う可能性があるということでElasticsearchについて調べています。
今回は「データ分析基盤構築入門」を読んだのでその内容を列挙。

## 歴史

- 分散型全文検索サーバー
- Shay Banonが2010年にOSSとしてリリース
- 全文検索ライブラリ Apache Lucene をコアに利用
- Elastic社によって開発・メンテナンスされている

## 特徴

- OSS (Apache License v2)
  - GitHub上でオープンソースとして公開されており、修正の報告やパッチも簡単に作成できる
- ドキュメント指向
  - ドキュメント単位でフィールドの定義が出来るため、柔軟なデータの登録ができる
  - スキーマフリー
- 分散システム
  - インデックスを分散して保持し、検索する。スケールアウトを当初から想定した設計
- マルチテナント
  - 複数のインデックスを登録できる
- RESTfulなAPI
  - データの操作や設定・監視などの必要な機能がHTTPインターフェースで利用できる
- (near)リアルタイム
  - (ほぼ)データをリアルタイムに検索できる

## Elastic Stack

- データの取り込みツールのLogstack、Beats、データストアElasticsearch、データ可視化ツールKibanaをまとめた総称
- Elastic社によって開発されているOSS群をまとめた総称
- version5.0からはElastic Stackのすべてのプロダクトが同時にリリースされるようになりました
- 統一されたテストも行われるので、組み合わせて利用する利点が増えてきている

## アーキテクチャ

- ノード
  - Elasticsearchの1プロセスに相当
  - 同一サーバー内で複数のノードを起動することも出来る
  - ノードは個別の名前やIDによって識別できる
  - ノード名はデフォルトでは、UUIDの先頭7文字が使用される
    - 内部的なノードIDとしてUUIDが利用される
- クラスタ
  - 複数のノードを1つのElasticsearchとして動作させることができ、このノード群のこと
  - クラスタ構成にすることで、大量のデータを複数のノードに分散して保持出来る
  - 可用性や検索性能の向上のためにクラスタ内でレプリカを持つことも出来る
  - クラスタへのデータ登録・検索、これらのノードへのリクエストに変換され、各ノードで処理が実行される
  - クラスタを構成するには、各ノードに同一のクラスタ名を指定する
  - クラスタ名はデフォルト elasticsearch
- ドキュメント
  - RDBMSの1レコードに相当
  - Elasticsearchが扱うデータの最小単位
  - データ形式は、通常JSON形式
  - Elasticsearchはスキーマフリー、各ドキュメントは異なった構造を持つことが出来る
  - 複数のフィールドから構成され、共通項目（フィールド）は同一の型を持つ必要がある
- フィールド
  - RDBMSのカラムに相当
  - フィールド毎に型を指定出来る
  - フィールドの設定は検索、表示に影響
    - どのような検索がしたいのか、どのようにフィールドを利用するのか
- インデックス
  - ドキュメントの集合
  - 基本インデックス単位でデータを管理
  - インデックスがクラスタのノードに分散して保持されることで、大量のデータを扱うことが出来る
  - インデックをノードに分散するための単位はシャード
- タイプ（インデックスタイプ）
  - インデックスに登録するドキュメントを論理的に分類するための機能
  - タイプを用いることで、インデックスに様々な種類のドキュメントを保存可能、管理も容易に
  - 1ドキュメント
    - このタイプを1つだけ指定できる
  - 1インデックス
    - 複数のタイプを利用できる
    - インデックスの異なるタイプでも、同じフィールドは同じ型を利用しないといけないなどの制限がある
    - => 1インデックス1タイプを推奨（今は必須？）
- シャード（セグメント）
  - 小さな単位に分割したインデックス
  - 他のデータストアではパーティションなどと呼ばれることもある
  - このシャードをクラスタの各ノードに割り当てることでデータを分散させている
  - このシャードの数がデータ分散させる事ができる上限数
  - 1つのインデックスをいくつのシャードに分散するかという設定、インデックス作成時のみ設定可能
  - Reindex APIを利用することで、別インデックスにデータを再登録出来る
  - 新しいインデックスのシャード数を変更することでシャードの分割数を変更できる
- プライマリシャード/レプリカシャード
  - シャード、プライマリとレプリカがある
  - データ登録リクエストが来ると、プライマリシャードにデータを保存、それからレプリカシャードにデータコピー
  - レプリカシャードは、プライマリシャードのコピー
- マッピング
  - インデックスに保存されるデータの構造を定義
  - タイプ毎にドキュメントのフィールドがどのような名前で、どのような型のデータを保存するか記述
- 転置インデックス
  - インデックス（シャード）はApache Luceneを使ってデータを管理

